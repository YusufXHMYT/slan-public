const fs=require('fs');
const Discord=require("discord.js");
const client=new Discord.Client();
const db = require('quick.db')
const moment = require("moment");
const ayarlar=require("./ayarlar.json");
const express = require('express');
/////
const app = express()
app.get('/', (req, res) => res.send("SLAN ARTIK AKTIF"))
app.listen(process.env.PORT, () => console.log('Port ayarlandƒ±: ' + process.env.PORT))
//////////////////



client.on("message", message => {
  let client = message.client;
  if (message.author.bot) return;
  if (!message.content.startsWith(ayarlar.prefix)) return;
  let command = message.content.split(' ')[0].slice(ayarlar.prefix.length);
  let params = message.content.split(' ').slice(1);
  let perms = client.yetkiler(message);
  let cmd;
  if (client.commands.has(command)) {
    cmd = client.commands.get(command);
  } else if (client.aliases.has(command)) {
    cmd = client.commands.get(client.aliases.get(command));
  }
  if (cmd) {
    if (perms < cmd.conf.permLevel) return;
    cmd.run(client, message, params, perms);
  }
})


client.on('ready', () => {
console.log(`Bota Giri≈üi Tamamlandƒ± Ben : ${client.user.tag}!`);
console.log("BOT ARTIK YAYINDA")

client.user.setActivity(`BAKIMDA | COMING BACK WITH V12`, {
type: "STREAMING",
url: "https://www.twitch.tv/rdr_lost"})
    .then(presence => console.log(`Your Status has been set to  ${presence.game ? presence.game.none : 'none'}`))
    .catch(console.error);
});

const log = message => {
  console.log(`[${moment().format("YYYY-MM-DD HH:mm:ss")}] ${message}`);
};


client.commands = new Discord.Collection();
client.aliases = new Discord.Collection();
fs.readdir('./komutlar/', (err, files) => {
  if (err) console.error(err);
  log(`${files.length} adet komut y√ºklemeye hazƒ±rlanƒ±lƒ±yor.`);
  files.forEach(f => {
    let props = require(`./komutlar/${f}`);
    log(`Y√ºklenen komut ismi: ${props.help.name.toUpperCase()}.`);
    client.commands.set(props.help.name, props);
    props.conf.aliases.forEach(alias => {
      client.aliases.set(alias, props.help.name);
    });
  });
});


client.reload = command => {
  return new Promise((resolve, reject) => {
    try {
      delete require.cache[require.resolve(`./komutlar/${command}`)];
      let cmd = require(`./komutlar/${command}`);
      client.commands.delete(command);
      client.aliases.forEach((cmd, alias) => {
        if (cmd === command) client.aliases.delete(alias);
      });
      client.commands.set(command, cmd);
      cmd.conf.aliases.forEach(alias => {
        client.aliases.set(alias, cmd.help.name);
      });
      resolve();
    } catch (e){
      reject(e);
    }
  });
};

client.load = command => {
  return new Promise((resolve, reject) => {
    try {
      let cmd = require(`./komutlar/${command}`);
      client.commands.set(command, cmd);
      cmd.conf.aliases.forEach(alias => {
        client.aliases.set(alias, cmd.help.name);
      });
      resolve();
    } catch (e){
      reject(e);
    }
  });
};

client.unload = command => {
  return new Promise((resolve, reject) => {
    try {
      delete require.cache[require.resolve(`./komutlar/${command}`)];
      let cmd = require(`./komutlar/${command}`);
      client.commands.delete(command);
      client.aliases.forEach((cmd, alias) => {
        if (cmd === command) client.aliases.delete(alias);
      });
      resolve();
    } catch (e){
      reject(e);
    }
  });
};


client.yetkiler = message => {
  if(!message.guild) {
	return; }
  let permlvl = 0;
  if(message.member.hasPermission("MANAGE_MESSAGES")) permlvl = 1;
  if(message.member.hasPermission("KICK_MEMBERS")) permlvl = 2;
  if(message.member.hasPermission("BAN_MEMBERS")) permlvl = 3;
  if(message.member.hasPermission("MANAGE_GUILD")) permlvl = 4;
  if(message.member.hasPermission("ADMINISTRATOR")) permlvl = 5;
  if(message.author.id === message.guild.ownerID) permlvl = 6;
  if(message.author.id === ayarlar.sahip) permlvl = 7;
  return permlvl;
};



client.on("message", async msg => {
    if(msg.author.bot) return;

    let i = await db.fetch(`reklamFiltre_${msg.guild.id}`)
          if (i == 'acik') {
              const reklam = ["https://","http://","discord.gg"];
              if (reklam.some(word => msg.content.toLowerCase().includes(word))) {
                try {
                  if (!msg.member.hasPermission("MANAGE_GUILD")) {
                    msg.delete();
                    return msg.channel.send(`${msg.author.tag}, Reklam Yapmak Yasak!`).then(msg => msg.delete(10000));
                  }
                } catch(err) {
                  console.log(err);
                }
              }
          }
          if (!i) return;
          });

client.on("guildCreate", async function(guild) {
    const owner = client.users.get(guild.ownerID)
    const kanal = "723440152822939689" //Eklendim mesajƒ±nƒ±n atƒ±lacaƒüƒ± kanal ID'sini giriniz.
    const darkcode = new Discord.MessageEmbed()
    .setTitle(`Yeni bir sunucuya eklendim`)
    .setColor("BLACK")
    .addField(`Sunucu Adƒ±`, guild.name)
    .addField(`Sunucu Sahibi`, owner.username + "#" +owner.discriminator)
    .addField(`Sunucu √úye Sayƒ±sƒ±`, guild.memberCount)
    client.channels.get(kanal).send({embed: darkcode}).catch(err => console.log("Kanala mesaj atamƒ±yorum!"))
    })

    client.on("guildDelete", async function(guild) {
    const owner = client.users.get(guild.ownerID)
    const kanal = "495488024759631882" //Atƒ±ldƒ±m mesajƒ±nƒ±n atƒ±lacaƒüƒ± kanal ID'sini giriniz.
    const darkcode = new Discord.MessageEmbed()
    .setTitle(`Bir sunucudan atƒ±ldƒ±m`)
    .setColor("BLACK")
    .addField(`Sunucu Adƒ±`, guild.name)
    .addField(`Sunucu Sahibi`, owner.username + "#" + owner.discriminator)
    .addField(`Sunucu √úye Sayƒ±sƒ±`, guild.memberCount)
    client.channels.get(kanal).send({embed: darkcode}).catch(err => console.log("Kanala mesaj atamƒ±yorum!"))
    })

client.on('message', async message => {
  const ms = require('ms');
  const args = message.content.slice(ayarlar.prefix.length).trim().split(/ +/g);
  const command = args.shift().toLowerCase();
  let u = message.mentions.users.first() || message.author;
  if (command === "sunucu-kur") {
  if (message.guild.channels.find(channel => channel.name === "Bot Kullanƒ±mƒ±")) return message.channel.send(" Bot Paneli Zaten Ayarlanmƒ±≈ü.")
  if (!message.member.hasPermission('ADMINISTRATOR'))
  return message.channel.send(" Bu Kodu `Y√∂netici` Yetkisi Olan Ki≈üi Kullanabilir.");
    message.channel.send(`Bot Bilgi Kanallarƒ±nƒ±n kurulumu ba≈ülatƒ±lsƒ±n mƒ±? ba≈ülatƒ±lacak ise **evet** yazƒ±nƒ±z.`)
      message.channel.awaitMessages(response => response.content === 'evet', {
        max: 1,
        time: 10000,
        errors: ['time'],
      })
    .then((collected) => {
   message.guild.createChannel('|‚ñ¨‚ñ¨|√ñNEMLƒ∞ KANALLAR|‚ñ¨‚ñ¨|', 'category', [{
  id: message.guild.id,
  deny: ['SEND_MESSAGES']
}])




 message.guild.createChannel('„ÄåüìÉ„Äçkurallar', 'text', [{
  id: message.guild.id,
  deny: ['SEND_MESSAGES']
}])
.then(channel =>
 channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|√ñNEMLƒ∞ KANALLAR|‚ñ¨‚ñ¨|")));
 message.guild.createChannel('„Äåüö™„Äçgelen-giden', 'text', [{
  id: message.guild.id,
  deny: ['SEND_MESSAGES']
}])
.then(channel =>
       channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|√ñNEMLƒ∞ KANALLAR|‚ñ¨‚ñ¨|")));
       message.guild.createChannel('„Äå‚úÖ„Äçsaya√ß', 'text', [{
        id: message.guild.id,
        deny: ['SEND_MESSAGES']
      }])
.then(channel =>
             channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|√ñNEMLƒ∞ KANALLAR|‚ñ¨‚ñ¨|")));
             message.guild.createChannel('„Äåüíæ„Äçlog-kanalƒ±', 'text', [{
              id: message.guild.id,
              deny: ['SEND_MESSAGES']
            }])
            .then(channel => channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|√ñNEMLƒ∞ KANALLAR|‚ñ¨‚ñ¨|")));
            message.guild.createChannel('„Äåüì¢„Äçduyuru-odasƒ±', 'text', [{
              id: message.guild.id,
              deny: ['SEND_MESSAGES']
            }])
.then(channel =>
 channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|√ñNEMLƒ∞ KANALLAR|‚ñ¨‚ñ¨|")));

       })
       .then((collected) => {
        message.guild.createChannel('|‚ñ¨‚ñ¨|GENEL KANALLAR|‚ñ¨‚ñ¨|', 'category', [{
       id: message.guild.id,
     }]);

      message.guild.createChannel(`„Äåüí°„Äç≈üikayet-ve-√∂neri`, 'text')
     .then(channel =>
      channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|GENEL KANALLAR|‚ñ¨‚ñ¨|")));
     message.guild.createChannel(`„Äåüë•„Äçpre-arama-odasƒ±`, 'text')
     .then(channel =>
            channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|GENEL KANALLAR|‚ñ¨‚ñ¨|")));
     message.guild.createChannel(`„Äåüì∑„Äçg√∂rsel-i√ßerik`, 'text')
     .then(channel =>
                  channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|GENEL KANALLAR|‚ñ¨‚ñ¨|")));
     message.guild.createChannel(`„Äåü§ñ„Äçbot-komutlarƒ±`, 'text')
     .then(channel =>
                  channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|GENEL KANALLAR|‚ñ¨‚ñ¨|")));
     message.guild.createChannel(`„Äåüí¨„Äçsohbet`, 'text')
     .then(channel =>
      channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|GENEL KANALLAR|‚ñ¨‚ñ¨|")));

      message.guild.createChannel(`üèÜ„ÄãKurucu Odasƒ±`, "voice")
      .then(channel =>
        channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|SES KANALLARI|‚ñ¨‚ñ¨|")))
      .then(c => {
        let role = message.guild.roles.find("name", "@everyone");
        let role2 = message.guild.roles.find("name", "Kurucu");

        c.overwritePermissions(role, {
            CONNECT: false,
        });
        c.overwritePermissions(role2, {
            CONNECT: true,

        });
    })

    message.guild.createChannel('|‚ñ¨‚ñ¨|SES KANALLARI|‚ñ¨‚ñ¨|', 'category', [{
      id: message.guild.id,
    }]);

    message.guild.createChannel(`üèÜ„ÄãY√∂netici Odasƒ±`, "voice")
    .then(channel =>
      channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|SES KANALLARI|‚ñ¨‚ñ¨|")))
    .then(c => {
      let role = message.guild.roles.find("name", "@everyone");
      let role2 = message.guild.roles.find("name", "Kurucu");
      let role3 = message.guild.roles.find("name", "Y√∂netici");
      c.overwritePermissions(role, {
          CONNECT: false,
      });
      c.overwritePermissions(role2, {
          CONNECT: true,
      });
      c.overwritePermissions(role3, {
          CONNECT: true,
      });
  })

  message.guild.createChannel(`üí¨„ÄãSohbet Odasƒ±`, "voice")
  .then(channel =>
    channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|SES KANALLARI|‚ñ¨‚ñ¨|")))
  .then(c => {
    let role = message.guild.roles.find("name", "@everyone");
    c.overwritePermissions(role, {
        CONNECT: true,
    });
})

message.guild.createChannel('|‚ñ¨‚ñ¨|OYUN ODALARI|‚ñ¨‚ñ¨|', 'category', [{
  id: message.guild.id,
}]);

message.guild.createChannel(`üéÆ„ÄãLOL`, 'voice')
.then(channel =>
 channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|OYUN ODALARI|‚ñ¨‚ñ¨|")))
 message.guild.createChannel(`üéÆ„ÄãZULA`, 'voice')
 .then(channel =>
  channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|OYUN ODALARI|‚ñ¨‚ñ¨|")))
 message.guild.createChannel(`üéÆ„ÄãCOUNTER STRƒ∞KE`, 'voice')
.then(channel =>
 channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|OYUN ODALARI|‚ñ¨‚ñ¨|")))
 message.guild.createChannel(`üéÆ„ÄãPUBG`, 'voice')
 .then(channel =>
  channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|OYUN ODALARI|‚ñ¨‚ñ¨|")))
  message.guild.createChannel(`üéÆ„ÄãFORTNƒ∞TE`, 'voice')
  .then(channel =>
   channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|OYUN ODALARI|‚ñ¨‚ñ¨|")))
   message.guild.createChannel(`üéÆ„ÄãMƒ∞NECRAFT`, 'voice')
   .then(channel =>
    channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|OYUN ODALARI|‚ñ¨‚ñ¨|")))
    message.guild.createChannel(`üéÆ„ÄãROBLOX`, 'voice')
    .then(channel =>
     channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|OYUN ODALARI|‚ñ¨‚ñ¨|")))
     message.guild.createChannel(`üéÆ„ÄãWOLFTEAM`, 'voice')
     .then(channel =>
      channel.setParent(message.guild.channels.find(channel => channel.name === "|‚ñ¨‚ñ¨|OYUN ODALARI|‚ñ¨‚ñ¨|")))



      message.guild.createRole({
        name: 'Kurucu',
        color: 'RED',
        permissions: [
            "ADMINISTRATOR",
    ]
      })


      message.guild.createRole({
        name: 'Y√∂netici',
        color: 'BLUE',
        permissions: [
            "MANAGE_GUILD",
            "MANAGE_ROLES",
            "MUTE_MEMBERS",
            "DEAFEN_MEMBERS",
            "MANAGE_MESSAGES",
            "MANAGE_NICKNAMES",
            "KICK_MEMBERS"
    ]
      })

      message.guild.createRole({
        name: 'Moderat√∂r',
        color: 'GREEN',
        permissions: [
            "MANAGE_GUILD",
            "MANAGE_ROLES",
            "MUTE_MEMBERS",
            "DEAFEN_MEMBERS",
            "MANAGE_MESSAGES",
            "MANAGE_NICKNAMES"
    ]
      })

      message.guild.createRole({
        name: 'V.I.P',
        color: '00ffff',
      })

      message.guild.createRole({
        name: '√úye',
        color: 'WHITE',
      })

      message.guild.createRole({
        name: 'Bot',
        color: 'ORANGE',
      })

       message.channel.send("Gerekli Odalar Kuruldu!")

            })

}

});


client.on("messageUpdate", msg => {


 const i = db.fetch(`${msg.guild.id}.kufur`)
    if (i) {
        const kufur = ["o√ß", "amk", "ananƒ± sikiyim","pi√ß","orospu √ßocuƒüu","orospu","oruspu"];
        if (kufur.some(word => msg.content.includes(word))) {
          try {
            if (!msg.member.hasPermission("BAN_MEMBERS")) {
                  msg.delete();

                      return msg.reply('Bu Sunucuda K√ºf√ºr Filtresi Aktiftir.').then(msg => msg.delete(3000));
            }
          } catch(err) {
            console.log(err);
          }
        }
    }
    if (!i) return;
});

client.on("message", async msg => {


  const i = await db.fetch(`ssaass_${msg.guild.id}`);
    if (i == 'acik') {
      if (msg.content.toLowerCase() == 'sa' || msg.content.toLowerCase() == 's.a' || msg.content.toLowerCase() == 'selamun aleyk√ºm' || msg.content.toLowerCase() == 'sea'|| msg.content.toLowerCase() == 'selam') {
          try {

                  return msg.reply('Aleyk√ºm Selam, Ho≈ügeldin')
          } catch(err) {
            console.log(err);
          }
      }
    }
    else if (i == 'kapali') {

    }
    if (!i) return;

    });

client.login(ayarlar.token)
